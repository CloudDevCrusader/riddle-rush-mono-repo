version: 2.1
setup: true

orbs:
  shellcheck: circleci/shellcheck@3.2

filters: &filters
  tags:
    only: /.*/

workflows:
  # Main workflow for flaky test detection using Trunk CLI
  flaky-test-detection:
    jobs:
      - install-trunk-cli
      - run-tests-with-trunk:
          requires:
            - install-trunk-cli
      - detect-flaky-tests:
          requires:
            - run-tests-with-trunk

  # Optional E2E test workflow (runs after main workflow)
  e2e-tests:
    jobs:
      - e2e-setup:
          filters: *filters
      - e2e-run-tests:
          requires:
            - e2e-setup
          filters: *filters

jobs:
  install-trunk-cli:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: Install Trunk CLI
          command: |
            curl -fsSLO --retry 3 https://trunk.io/releases/trunk && chmod +x ./trunk
            ./trunk --version
      - persist_to_workspace:
          root: .
          paths:
            - trunk

  run-tests-with-trunk:
    docker:
      - image: cimg/node:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Setup corepack and install dependencies
          command: |
            # Conditionally enable corepack only if not already available
            if ! command -v pnpm &> /dev/null; then
              echo "pnpm not found, enabling corepack..."
              corepack enable && corepack prepare pnpm@10.27.0 --activate
            else
              echo "pnpm already available, skipping corepack setup"
            fi

            # Only install if node_modules is missing or outdated
            if [ ! -d "node_modules" ] || [ ! -f "node_modules/.modules.yaml" ]; then
              echo "Installing dependencies..."
              pnpm install --frozen-lockfile
            else
              echo "Using cached dependencies"
              # Ensure lockfile is in sync
              pnpm install --frozen-lockfile --prefer-offline
            fi
      - run:
          name: Run tests with JUnit reporting for Trunk
          command: |
            chmod +x scripts/run-tests-with-trunk.sh
            ./scripts/run-tests-with-trunk.sh
      - store_test_results:
          path: apps/game/test-results
      - store_artifacts:
          path: apps/game/test-results

  detect-flaky-tests:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Detect flaky tests using Trunk CLI
          command: |
            # Check if Trunk CLI is available
            if [ ! -f "./trunk" ]; then
              echo "âŒ Trunk CLI not found, installing..."
              curl -fsSLO --retry 3 https://trunk.io/releases/trunk && chmod +x ./trunk
            fi

            # Check if test results exist
            if [ ! -d "apps/game/test-results" ] || [ -z "$(ls -A apps/game/test-results/*.xml 2>/dev/null)" ]; then
              echo "âŒ No test results found in apps/game/test-results/"
              exit 1
            fi

            # Check if TRUNK_API_TOKEN is set
            if [ -z "${TRUNK_API_TOKEN}" ]; then
              echo "âŒ TRUNK_API_TOKEN environment variable is not set"
              exit 1
            fi

            # Upload test results to Trunk for flaky test analysis
            echo "ðŸ” Uploading test results to Trunk for flaky test analysis..."
            ./trunk flakytests upload --junit-paths "apps/game/test-results/*.xml" --org-url-slug cloudcrusaders --token "${TRUNK_API_TOKEN}"

            echo "âœ… Flaky test detection completed successfully"
          no_output_timeout: 10m

  # E2E Test Jobs (Optional - runs as second step)
  e2e-setup:
    docker:
      - image: cimg/node:current
    steps:
      - checkout
      - run:
          name: Setup corepack and install dependencies
          command: |
            # Conditionally enable corepack only if not already available
            if ! command -v pnpm &> /dev/null; then
              echo "pnpm not found, enabling corepack..."
              corepack enable && corepack prepare pnpm@10.27.0 --activate
            else
              echo "pnpm already available, skipping corepack setup"
            fi

            # Install dependencies
            if [ ! -d "node_modules" ] || [ ! -f "node_modules/.modules.yaml" ]; then
              echo "Installing dependencies..."
              pnpm install --frozen-lockfile
            else
              echo "Using cached dependencies"
              pnpm install --frozen-lockfile --prefer-offline
            fi
      - run:
          name: Build application for E2E tests
          command: |
            cd apps/game
            pnpm run build
            echo "âœ… Build completed successfully"
      - persist_to_workspace:
          root: .
          paths:
            - apps/game/.output
            - node_modules

  e2e-run-tests:
    docker:
      - image: cimg/node:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Playwright browsers
          command: |
            cd apps/game
            npx playwright install --with-deps
            echo "âœ… Playwright browsers installed"
      - run:
          name: Run E2E tests with JUnit reporting
          command: |
            cd apps/game
            # Use the simple configuration for more reliable tests
            pnpm run test:e2e:simple --reporter=junit,list
            echo "âœ… E2E tests completed"
          no_output_timeout: 30m
      - store_test_results:
          path: apps/game/test-results
      - store_artifacts:
          path: apps/game/test-results
      - store_artifacts:
          path: apps/game/playwright-report-simple
