version: 2.1
setup: true

orbs:
  shellcheck: circleci/shellcheck@3.2

filters: &filters
  tags:
    only: /.*/

workflows:
  # Main workflow for flaky test detection using Trunk CLI
  flaky-test-detection:
    jobs:
      - install-trunk-cli
      - run-tests-with-trunk:
          requires:
            - install-trunk-cli
      - detect-flaky-tests:
          requires:
            - run-tests-with-trunk

jobs:
  install-trunk-cli:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: Install Trunk CLI
          command: |
            curl -fsSLO --retry 3 https://trunk.io/releases/trunk && chmod +x ./trunk
            ./trunk --version
      - persist_to_workspace:
          root: .
          paths:
            - trunk

  run-tests-with-trunk:
    docker:
      - image: cimg/node:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Setup corepack and install dependencies
          command: |
            # Conditionally enable corepack only if not already available
            if ! command -v pnpm &> /dev/null; then
              echo "pnpm not found, enabling corepack..."
              corepack enable && corepack prepare pnpm@10.27.0 --activate
            else
              echo "pnpm already available, skipping corepack setup"
            fi

            # Only install if node_modules is missing or outdated
            if [ ! -d "node_modules" ] || [ ! -f "node_modules/.modules.yaml" ]; then
              echo "Installing dependencies..."
              pnpm install --frozen-lockfile
            else
              echo "Using cached dependencies"
              # Ensure lockfile is in sync
              pnpm install --frozen-lockfile --prefer-offline
            fi
      - run:
          name: Run tests with JUnit reporting for Trunk
          command: |
            chmod +x scripts/run-tests-with-trunk.sh
            ./scripts/run-tests-with-trunk.sh
      - store_test_results:
          path: apps/game/test-results
      - store_artifacts:
          path: apps/game/test-results

  detect-flaky-tests:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Detect flaky tests using Trunk CLI
          command: |
            # Check if Trunk CLI is available
            if [ ! -f "./trunk" ]; then
              echo "‚ùå Trunk CLI not found, installing..."
              curl -fsSLO --retry 3 https://trunk.io/releases/trunk && chmod +x ./trunk
            fi

            # Check if test results exist
            echo "üîç Checking for test results..."
            if [ ! -d "apps/game/test-results" ]; then
              echo "‚ùå Test results directory not found: apps/game/test-results/"
              echo "Available directories:"
              ls -la apps/game/ || echo "Game directory not found"
              exit 1
            fi

            if [ -z "$(ls -A apps/game/test-results/*.xml 2>/dev/null)" ]; then
              echo "‚ùå No XML test results found in apps/game/test-results/"
              echo "Available files in test-results/:"
              ls -la apps/game/test-results/ || echo "Directory is empty"
              exit 1
            fi

            echo "‚úÖ Found test results:"
            ls -la apps/game/test-results/*.xml

            # Check if TRUNK_API_TOKEN is set
            if [ -z "${TRUNK_API_TOKEN}" ]; then
              echo "‚ùå TRUNK_API_TOKEN environment variable is not set"
              echo "Please set this environment variable in CircleCI project settings"
              exit 1
            fi

            # Upload test results to Trunk for flaky test analysis
            echo "üîç Uploading test results to Trunk for flaky test analysis..."
            ./trunk flakytests upload --junit-paths "apps/game/test-results/*.xml" --org-url-slug cloudcrusaders --token "${TRUNK_API_TOKEN}"

            echo "‚úÖ Flaky test detection completed successfully"
          no_output_timeout: 10m
