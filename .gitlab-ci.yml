# Use custom CI image with pre-installed dependencies for faster builds
# To build the image, trigger the .gitlab/docker-image.yml pipeline manually
# To use standard node image instead, set CI_IMAGE to 'node:20'
image: ${CI_REGISTRY_IMAGE}/ci-build:latest

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  # Fallback to standard node image if custom image not available
  CI_IMAGE: ${CI_REGISTRY_IMAGE}/ci-build:latest

# Cache is less critical with custom image, but keep for fresh installs
cache:
  key: deps-v3
  paths:
    - node_modules/
  policy: pull-push

# Workflow rules to control when pipelines run (save runner credits)
workflow:
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run manually via web UI or API
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run on version tags (for AWS deployment)
    - if: $CI_COMMIT_TAG
    # Run on main branch (for GitLab Pages docs deployment)
    - if: $CI_COMMIT_BRANCH == "main"
    # All other cases - prevent auto-run
    - when: never

stages:
  - test
  - quality
  - build
  - deploy
  - verify

# Simplified before_script - dependencies may be pre-installed in custom image
before_script:
  - corepack enable
  - corepack prepare pnpm@10.27.0 --activate
  # Only install if node_modules is missing or outdated
  - |
    if [ ! -d "node_modules" ] || [ ! -f "node_modules/.modules.yaml" ]; then
      echo "Installing dependencies..."
      pnpm install --frozen-lockfile
    else
      echo "Using cached dependencies from custom image"
      # Ensure lockfile is in sync
      pnpm install --frozen-lockfile --prefer-offline
    fi

# Unit tests - gates build (only runs when game app changes)
test:
  stage: test
  script:
    - chmod +x scripts/ci-test.sh && ./scripts/ci-test.sh
  rules:
    # Always run on tags (for AWS deployment)
    - if: $CI_COMMIT_TAG
    # Always run on manual triggers
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run when game app or shared packages change
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - apps/game/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - package.json
        - .gitlab-ci.yml
        - scripts/ci-test.sh
    # Run on main/staging/development branches when game changes
    - if: $CI_COMMIT_BRANCH =~ /^(main|staging|development)$/
      changes:
        - apps/game/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - package.json

# ====================================
# Code Quality - SonarCloud Analysis
# ====================================

sonarcloud-check:
  stage: quality
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  only:
    - merge_requests
    - master
    - main
    - develop
    - development
    - staging
    - staging

# E2E tests - local build (manual, optional) - only when game changes
# Note: This job tests local build, not deployed sites
test:e2e:local:
  stage: test
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.27.0 --activate
    - pnpm install --frozen-lockfile
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  rules:
    # Manual trigger, available when game changes
    - if: $CI_COMMIT_BRANCH =~ /^(main|staging|development)$/
      changes:
        - apps/game/**/*
        - packages/**/*
        - tests/e2e/**/*
        - playwright.config.ts
      when: manual
      allow_failure: true
    # Always available on tags
    - if: $CI_COMMIT_TAG
      when: manual
      allow_failure: true

# Build game app (only when game changes)
build:
  stage: build
  script:
    - chmod +x scripts/ci-build.sh && ./scripts/ci-build.sh
  artifacts:
    paths:
      - apps/game/.output/
    expire_in: 7 days
  needs:
    - job: test
      artifacts: false
  rules:
    # Always run on tags (for AWS deployment)
    - if: $CI_COMMIT_TAG
    # Always run on manual triggers
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run when game app changes
    - if: $CI_COMMIT_BRANCH =~ /^(main|staging|development)$/
      changes:
        - apps/game/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - package.json
        - scripts/ci-build.sh

# ====================================
# GitLab Pages - Documentation Site
# ====================================

# Build documentation site (Nuxt Content) - only when docs change
build:docs:
  stage: build
  image: node:20
  before_script:
    - corepack enable && corepack prepare pnpm@10.27.0 --activate
  script:
    - pnpm install --frozen-lockfile
    - cd apps/docs
    - pnpm run generate
    - |
      # Copy generated docs to public directory for GitLab Pages
      # GitLab Pages serves from 'public/' directory at repo root
      cd ../..
      mkdir -p public
      # Copy all generated files to public/
      if [ -d "apps/docs/.output/public" ]; then
        cp -r apps/docs/.output/public/* public/
        echo "✅ Copied docs output to public/"
        ls -la public/ | head -10
      else
        echo "❌ Error: apps/docs/.output/public not found"
        exit 1
      fi
  artifacts:
    paths:
      - public
    expire_in: 1 hour
  rules:
    # Always run on main when docs change
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - apps/docs/**/*
        - docs/**/*
        - CLAUDE.md
        - README.md
    # Always run on manual triggers
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main"

# Deploy documentation to GitLab Pages - only when docs change
pages:
  stage: deploy
  dependencies:
    - build:docs
  script:
    - echo "Documentation deployed to GitLab Pages"
  artifacts:
    paths:
      - public
  environment:
    name: production
    url: https://djdiox.gitlab.io/riddle-rush-nuxt-pwa
  rules:
    # Deploy when docs are built
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - apps/docs/**/*
        - docs/**/*
        - CLAUDE.md
        - README.md
    # Always deploy on manual triggers
    - if: $CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main"

# ====================================
# AWS Deployment (Tags Only)
# ====================================

deploy:aws:
  stage: deploy
  image: node:20
  before_script:
    - apt-get update && apt-get install -y awscli
    - corepack enable
    - corepack prepare pnpm@10.27.0 --activate
    - pnpm install --frozen-lockfile
  script:
    - echo "Deploying to AWS S3 + CloudFront..."
    - chmod +x aws-deploy.sh
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
    - export AWS_S3_BUCKET=$AWS_S3_BUCKET
    - export AWS_CLOUDFRONT_ID=$AWS_CLOUDFRONT_ID
    - export AWS_REGION=${AWS_REGION:-us-east-1}
    - ./aws-deploy.sh production
  artifacts:
    paths:
      - deployment-info.json
      - apps/game/.output/
    expire_in: 30 days
  environment:
    name: aws-production
    url: https://$AWS_CLOUDFRONT_DOMAIN
  needs:
    - build
  rules:
    # Deploy on version tags only
    - if: $CI_COMMIT_TAG

# ====================================
# Verify Stage - E2E Tests on Deployed Sites (Optional)
# ====================================

# E2E tests - AWS Production (manual, optional)
# Note: Tests AWS deployment, not GitLab Pages (which now hosts docs)
verify:e2e:aws:
  stage: verify
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.27.0 --activate
    - pnpm install --frozen-lockfile
    - |
      if [ -n "$AWS_CLOUDFRONT_DOMAIN" ]; then
        export BASE_URL=https://$AWS_CLOUDFRONT_DOMAIN
      else
        export BASE_URL=http://$AWS_S3_BUCKET.s3-website-${AWS_REGION:-us-east-1}.amazonaws.com
      fi
    - echo 'Testing AWS deployment at:' $BASE_URL
    - echo 'Waiting 60 seconds for CloudFront invalidation to propagate...'
    - sleep 60
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  needs:
    - deploy:aws
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 30 days
  rules:
    # Manual trigger on tags only
    - if: $CI_COMMIT_TAG
      when: manual
      allow_failure: true
