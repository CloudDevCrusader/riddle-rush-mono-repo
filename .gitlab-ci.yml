image: node:20

cache:
  key: ${CI_COMMIT_REF_SLUG}-deps
  paths:
    - node_modules/
    - .npm/

stages:
  - lint
  - test
  - build
  - deploy:dev
  - deploy:staging
  - deploy:prod
  - maintenance

variables:
  NODE_OPTIONS: "--max_old_space_size=4096"
  CI: "true"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

.node-setup: &node-setup
  before_script:
    - npm ci --prefer-offline --no-audit

lint:
  stage: lint
  <<: *node-setup
  script:
    - npm run lint
    - npm run format:check
  allow_failure: true
  only:
    - main
    - master
    - merge_requests

typecheck:
  stage: lint
  <<: *node-setup
  script:
    - npm run typecheck
  only:
    - main
    - master
    - merge_requests

test:unit:
  stage: test
  <<: *node-setup
  script:
    - npm run test:unit:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 30 days
  only:
    - main
    - master
    - merge_requests

# E2E Tests with Playwright (screenshots on failure)
test:e2e:
  stage: test
  image: mcr.microsoft.com/playwright:v1.52.0-noble
  before_script:
    - npm ci --prefer-offline
  script:
    - npm run generate
    - npx playwright test --reporter=html,list,json || E2E_FAILED=true
    - |
      # Create summary of test results
      echo "üìä E2E Test Results" > e2e-summary.txt
      echo "===================" >> e2e-summary.txt
      echo "Branch: $CI_COMMIT_REF_NAME" >> e2e-summary.txt
      echo "Commit: $CI_COMMIT_SHORT_SHA" >> e2e-summary.txt
      echo "Date: $(date)" >> e2e-summary.txt
      echo "" >> e2e-summary.txt
      
      if [ -f "test-results/.last-run.json" ]; then
        cat test-results/.last-run.json >> e2e-summary.txt
      fi
      
      # List screenshots if any
      if [ -d "test-results" ] && [ "$(find test-results -name '*.png' 2>/dev/null | wc -l)" -gt 0 ]; then
        echo "" >> e2e-summary.txt
        echo "üì∏ Screenshots captured:" >> e2e-summary.txt
        find test-results -name "*.png" -exec basename {} \; >> e2e-summary.txt
      fi
      
      if [ "$E2E_FAILED" = "true" ]; then
        echo ""
        echo "‚ùå E2E tests failed!"
        echo "üì∏ Screenshots: Download 'e2e-results' artifact"
        echo "üìÑ HTML Report: Download and open playwright-report/index.html"
        exit 1
      else
        echo "‚úÖ All E2E tests passed!"
      fi
  artifacts:
    name: "e2e-results-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    when: always
    paths:
      - playwright-report/
      - test-results/
      - e2e-summary.txt
    reports:
      junit: test-results/junit.xml
    expose_as: 'E2E Test Results'
    expire_in: 14 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "stable"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH == "staging"
      when: manual
      allow_failure: true
  retry:
    max: 1
    when: script_failure

build:
  stage: build
  <<: *node-setup
  script:
    - npm run generate
    - echo "Build completed at $(date)" > .output/build-info.txt
    - echo "Commit: $CI_COMMIT_SHA" >> .output/build-info.txt
    - echo "Branch: $CI_COMMIT_REF_NAME" >> .output/build-info.txt
    - echo "Environment: $CI_ENVIRONMENT_NAME" >> .output/build-info.txt
  artifacts:
    name: "build-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - .output/
      - .nuxt/
    expire_in: 7 days
  needs:
    - job: test:unit
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "stable"
    - if: $CI_COMMIT_BRANCH == "staging"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_MERGE_REQUEST_ID

# ===================
# DEPLOYMENT STAGES
# ===================

# Dev Environment - feature branches and dev branch
deploy:dev:
  stage: deploy:dev
  script:
    - rm -rf public
    - cp -r .output/public public
    - mkdir -p public/test-reports
    - cp -r coverage public/test-reports/ 2>/dev/null || true
    - cp .output/build-info.txt public/ 2>/dev/null || true
    - echo "üöÄ Deployed to DEV environment"
  artifacts:
    name: "dev-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - public
    expire_in: 3 days
  needs:
    - job: build
      artifacts: true
  environment:
    name: dev
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/dev
    on_stop: stop:dev
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH =~ /^feature\//
      when: manual
      allow_failure: true

stop:dev:
  stage: deploy:dev
  script:
    - echo "üõë Stopping DEV environment"
  environment:
    name: dev
    action: stop
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
      when: manual
  allow_failure: true

# Staging Environment - staging branch
deploy:staging:
  stage: deploy:staging
  script:
    - rm -rf public
    - cp -r .output/public public
    - mkdir -p public/test-reports
    - cp -r coverage public/test-reports/ 2>/dev/null || true
    - cp .output/build-info.txt public/ 2>/dev/null || true
    - echo "üé≠ Deployed to STAGING environment"
  artifacts:
    name: "staging-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - public
    expire_in: 14 days
  needs:
    - job: build
      artifacts: true
    - job: test:unit
      artifacts: true
  environment:
    name: staging
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/staging
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"

# Production Environment - main/master/stable branch (GitLab Pages)
pages:
  stage: deploy:prod
  script:
    - rm -rf public
    - cp -r .output/public public
    - mkdir -p public/test-reports
    - cp -r coverage public/test-reports/ 2>/dev/null || true
    - cp .output/build-info.txt public/ 2>/dev/null || true
    - echo "üöÄ Deployed to PRODUCTION environment"
  artifacts:
    name: "prod-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - public
    expire_in: 30 days
  needs:
    - job: build
      artifacts: true
    - job: test:unit
      artifacts: true
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "stable"

# ============================================
# MAINTENANCE JOBS (Manual/Scheduled Triggers)
# ============================================

.maintenance-setup: &maintenance-setup
  before_script:
    - echo "üì¶ Installing dependencies..."
    - npm ci --prefer-offline
    - echo "‚úÖ Dependencies installed"

# Dev Stats - prints project health metrics
dev-stats:
  stage: maintenance
  <<: *maintenance-setup
  script:
    - echo "üìä PROJECT HEALTH REPORT"
    - echo "========================"
    - echo ""
    - echo "üì¶ Package Info:"
    - node -e "const p=require('./package.json'); console.log('  Name:', p.name); console.log('  Dependencies:', Object.keys(p.dependencies||{}).length); console.log('  DevDependencies:', Object.keys(p.devDependencies||{}).length)"
    - echo ""
    - echo "üîç Security Audit:"
    - npm audit --json 2>/dev/null | node -e "const d=require('fs').readFileSync(0,'utf8'); try{const a=JSON.parse(d); console.log('  Vulnerabilities:', JSON.stringify(a.metadata?.vulnerabilities||'N/A'))}catch{console.log('  No issues found')}" || true
    - echo ""
    - echo "üìè Code Stats:"
    - echo "  TypeScript files:" $(find . -name "*.ts" -not -path "./node_modules/*" -not -path "./.nuxt/*" | wc -l)
    - echo "  Vue components:" $(find . -name "*.vue" -not -path "./node_modules/*" -not -path "./.nuxt/*" | wc -l)
    - echo "  Test files:" $(find ./tests -name "*.spec.ts" -o -name "*.test.ts" 2>/dev/null | wc -l)
    - echo "  Total lines:" $(find . \( -name "*.ts" -o -name "*.vue" \) -not -path "./node_modules/*" -not -path "./.nuxt/*" -exec cat {} \; | wc -l)
    - echo ""
    - echo "üìÅ Bundle Analysis (estimate):"
    - du -sh node_modules 2>/dev/null || echo "  node_modules not cached"
    - echo ""
    - echo "üîß Outdated Packages:"
    - npm outdated --json 2>/dev/null | node -e "const d=require('fs').readFileSync(0,'utf8'); try{const o=JSON.parse(d); const k=Object.keys(o); console.log('  Outdated:', k.length); k.slice(0,5).forEach(p=>console.log('   -',p,o[p].current,'->',o[p].latest))}catch{console.log('  All up to date!')}" || echo "  All up to date!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "trigger"
  allow_failure: true

# Security Audit - detailed vulnerability report
security-audit:
  stage: maintenance
  <<: *maintenance-setup
  script:
    - echo "üîê SECURITY AUDIT REPORT"
    - echo "========================"
    - npm audit || true
    - echo ""
    - echo "üìã Audit Summary:"
    - npm audit --json 2>/dev/null | node -e "
        const d=require('fs').readFileSync(0,'utf8');
        try {
          const a=JSON.parse(d);
          const v=a.metadata?.vulnerabilities||{};
          console.log('  Critical:', v.critical||0);
          console.log('  High:', v.high||0);
          console.log('  Moderate:', v.moderate||0);
          console.log('  Low:', v.low||0);
          console.log('  Info:', v.info||0);
          console.log('  Total:', v.total||0);
        } catch { console.log('  No vulnerabilities found'); }
      " || true
  artifacts:
    paths:
      - npm-audit.json
    expire_in: 7 days
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "trigger"
  allow_failure: true

# Auto-fix npm audit vulnerabilities (creates MR)
audit-fix:
  stage: maintenance
  image: node:20
  before_script:
    - apt-get update && apt-get install -y git
    - git config --global user.email "ci-bot@gitlab.com"
    - git config --global user.name "CI Bot"
    - npm ci --prefer-offline
  script:
    - echo "üîß ATTEMPTING AUTO-FIX"
    - echo "======================"
    - |
      # Check if there are fixable vulnerabilities
      AUDIT_RESULT=$(npm audit --json 2>/dev/null || true)
      FIXABLE=$(echo "$AUDIT_RESULT" | node -e "const d=require('fs').readFileSync(0,'utf8'); try{const a=JSON.parse(d); console.log(a.metadata?.vulnerabilities?.total||0)}catch{console.log(0)}")
      
      if [ "$FIXABLE" -gt 0 ]; then
        echo "Found $FIXABLE vulnerabilities, attempting fix..."
        npm audit fix --force || true
        
        # Check if package.json or package-lock.json changed
        if git diff --quiet package.json package-lock.json; then
          echo "No changes made by audit fix"
        else
          echo "Changes detected, creating branch..."
          BRANCH="ci/audit-fix-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add package.json package-lock.json
          git commit -m "fix(deps): auto-fix npm audit vulnerabilities

          Automated fix by GitLab CI maintenance pipeline.
          Run: npm audit fix --force"
          
          echo "Branch created: $BRANCH"
          echo "To push and create MR, configure CI_PUSH_TOKEN variable"
        fi
      else
        echo "No vulnerabilities to fix!"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "trigger"
      variables:
        - $AUDIT_FIX == "true"
  allow_failure: true

# Update all dependencies (creates report)
deps-update-check:
  stage: maintenance
  <<: *maintenance-setup
  script:
    - echo "üì¶ DEPENDENCY UPDATE CHECK"
    - echo "=========================="
    - npm outdated --long || true
    - echo ""
    - echo "üîÑ Update Commands:"
    - echo "  Minor updates: npm update"
    - echo "  Major updates: npx npm-check-updates -u"
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true

# License check
license-check:
  stage: maintenance
  <<: *maintenance-setup
  script:
    - echo "üìú LICENSE CHECK"
    - echo "================"
    - npx license-checker --summary || echo "Install license-checker for detailed report"
    - echo ""
    - echo "‚ö†Ô∏è  Review licenses for compliance with your project requirements"
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  allow_failure: true

# Bundle size analysis (uses build artifact)
bundle-analysis:
  stage: maintenance
  <<: *maintenance-setup
  needs:
    - job: build
      artifacts: true
      optional: true
  script:
    - echo "üìä BUNDLE SIZE ANALYSIS"
    - echo "======================="
    - |
      if [ -d ".output" ]; then
        echo "üìÅ Build Output:"
        du -sh .output/ 2>/dev/null || echo "  No .output directory"
        echo ""
        echo "üìÅ Public Assets:"
        du -sh .output/public/* 2>/dev/null | sort -h | tail -10 || echo "  No public assets"
        echo ""
        echo "üìÅ Server Chunks:"
        du -sh .output/server/chunks/* 2>/dev/null | sort -h | tail -10 || echo "  No server chunks"
        echo ""
        echo "üìÑ Build Info:"
        cat .output/build-info.txt 2>/dev/null || echo "  No build info available"
      else
        echo "‚ö†Ô∏è  No build artifacts found. Run build job first."
      fi
    - echo ""
    - echo "üì¶ Node Modules Size:"
    - du -sh node_modules 2>/dev/null || echo "  Not available"
  artifacts:
    paths:
      - bundle-report.txt
    expire_in: 7 days
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
