image: node:20

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

cache:
  key: deps-v2
  paths:
    - node_modules/

# Workflow rules to control when pipelines run (save runner credits)
workflow:
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run manually via web UI or API
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run on version tags (for AWS deployment)
    - if: $CI_COMMIT_TAG
    # All other cases (push to branches) - prevent auto-run
    - when: never

stages:
  - test
  - quality
  - build
  - deploy
  - verify

before_script:
  - corepack enable
  - corepack prepare pnpm@10.26.2 --activate
  - pnpm install --frozen-lockfile

# Unit tests - gates build
test:
  stage: test
  script:
    - chmod +x scripts/ci-test.sh && ./scripts/ci-test.sh
  only:
    - main
    - staging
    - development
    - merge_requests
    - tags

# ====================================
# Code Quality - SonarCloud Analysis
# ====================================

sonarcloud-check:
  stage: quality
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  only:
    - merge_requests
    - master
    - main
    - develop
    - development
    - staging
    - staging

# E2E tests - local build (manual, optional)
test:e2e:local:
  stage: test
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.26.2 --activate
    - pnpm install --frozen-lockfile
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  when: manual
  allow_failure: true
  only:
    - main
    - staging
    - development
    - tags

# Build for all deployment branches and tags
build:
  stage: build
  script:
    - chmod +x scripts/ci-build.sh && ./scripts/ci-build.sh
  artifacts:
    paths:
      - .output/
    expire_in: 7 days
  needs:
    - job: test
      artifacts: false
  only:
    - main
    - staging
    - development
    - tags

# ====================================
# GitLab Pages Deployments
# ====================================

# Production - main branch
pages:
  stage: deploy
  script:
    - rm -rf public
    - cp -r .output/public public
  artifacts:
    paths:
      - public
  environment:
    name: production
    url: https://djdiox.gitlab.io/guess-game-nuxt-pwa
  needs:
    - build
  only:
    - main

# Staging deployment
deploy:staging:
  stage: deploy
  script:
    - rm -rf public
    - mkdir -p public/staging
    - cp -r .output/public/* public/staging/
    - echo "Staging deployment"
  artifacts:
    paths:
      - public
  environment:
    name: staging
    url: https://djdiox.gitlab.io/guess-game-nuxt-pwa/staging
  needs:
    - build
  only:
    - staging

# Development deployment
deploy:dev:
  stage: deploy
  script:
    - rm -rf public
    - mkdir -p public/dev
    - cp -r .output/public/* public/dev/
    - echo "Dev deployment"
  artifacts:
    paths:
      - public
  environment:
    name: development
    url: https://djdiox.gitlab.io/guess-game-nuxt-pwa/dev
  needs:
    - build
  only:
    - development

# ====================================
# AWS Deployment (Tags Only)
# ====================================

deploy:aws:
  stage: deploy
  image: node:20
  before_script:
    - apt-get update && apt-get install -y awscli
    - corepack enable
    - corepack prepare pnpm@10.26.2 --activate
    - pnpm install --frozen-lockfile
  script:
    - echo "Deploying to AWS S3 + CloudFront..."
    - chmod +x aws-deploy.sh
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
    - export AWS_S3_BUCKET=$AWS_S3_BUCKET
    - export AWS_CLOUDFRONT_ID=$AWS_CLOUDFRONT_ID
    - export AWS_REGION=${AWS_REGION:-us-east-1}
    - ./aws-deploy.sh production
  artifacts:
    paths:
      - deployment-info.json
    expire_in: 30 days
  environment:
    name: aws-production
    url: https://$AWS_CLOUDFRONT_DOMAIN
  needs:
    - build
  only:
    - tags
  except:
    - branches

# ====================================
# Verify Stage - E2E Tests on Deployed Sites (Optional)
# ====================================

# E2E tests - Production (manual, optional)
verify:e2e:production:
  stage: verify
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.26.2 --activate
    - pnpm install --frozen-lockfile
    - export BASE_URL=https://djdiox.gitlab.io/guess-game-nuxt-pwa
    - echo "Waiting 30 seconds for deployment to propagate..."
    - sleep 30
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  needs:
    - pages
  only:
    - main
  when: manual
  allow_failure: true

# E2E tests - Staging (manual, optional)
verify:e2e:staging:
  stage: verify
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.26.2 --activate
    - pnpm install --frozen-lockfile
    - export BASE_URL=https://djdiox.gitlab.io/guess-game-nuxt-pwa/staging
    - echo "Waiting 30 seconds for deployment to propagate..."
    - sleep 30
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  needs:
    - deploy:staging
  only:
    - staging
  when: manual
  allow_failure: true

# E2E tests - Development (manual, optional)
verify:e2e:dev:
  stage: verify
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.26.2 --activate
    - pnpm install --frozen-lockfile
    - export BASE_URL=https://djdiox.gitlab.io/guess-game-nuxt-pwa/dev
    - echo "Waiting 30 seconds for deployment to propagate..."
    - sleep 30
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  needs:
    - deploy:dev
  only:
    - development
  when: manual
  allow_failure: true

# E2E tests - AWS CloudFront (manual, optional)
verify:e2e:aws:
  stage: verify
  image: mcr.microsoft.com/playwright:v1.57.0-noble
  script:
    - corepack enable && corepack prepare pnpm@10.26.2 --activate
    - pnpm install --frozen-lockfile
    - |
      if [ -n "$AWS_CLOUDFRONT_DOMAIN" ]; then
        export BASE_URL=https://$AWS_CLOUDFRONT_DOMAIN
      else
        # Fallback to S3 website URL if CloudFront not configured
        export BASE_URL=http://$AWS_S3_BUCKET.s3-website-${AWS_REGION:-us-east-1}.amazonaws.com
      fi
    - echo "Testing AWS deployment at: $BASE_URL"
    - echo "Waiting 60 seconds for CloudFront invalidation to propagate..."
    - sleep 60
    - chmod +x scripts/ci-e2e.sh && ./scripts/ci-e2e.sh
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 30 days
  needs:
    - deploy:aws
  only:
    - tags
  when: manual
  allow_failure: true
